# 东方财富股票公告下载器

这是一个用于爬取东方财富网站股票公告的Python爬虫程序，支持自动下载PDF格式的公告文件并按类型分类存储。

## 功能特点

- 🔍 **智能爬取**：自动获取指定股票的公告列表
- 📁 **分类存储**：按公告类型自动创建文件夹并分类保存
- 📄 **PDF下载**：自动下载公告PDF文件，支持断点续传和重试机制
- 🛡️ **反爬虫**：内置请求头和延迟机制，避免被网站封禁
- ⚙️ **配置灵活**：通过配置文件轻松修改股票代码和公告类型
- 🔄 **完整性验证**：下载后自动验证文件大小，确保下载完整
- 💾 **智能缓存**：自动缓存API请求数据，避免重复请求，提高效率

## 文件结构

```
East_money_stock_notice_download/
├── main.py              # 主程序文件，爬虫核心逻辑
├── config.json          # 配置文件，设置股票代码和公告类型
├── test.py              # 测试文件，用于功能测试
├── readme.md            # 说明文档
├── .gitignore           # Git忽略文件
├── cache/               # 缓存目录，存储API请求数据
└── {股票简称}pdf/       # PDF存储目录，按公告类型分类
    ├── 定期报告/
    ├── 业绩预告/
    ├── 重大事项/
    └── ...
```

## 环境要求

- Python 3.6+
- 操作系统：Windows/Linux/macOS
- 网络连接：需要访问东方财富网站

### 依赖包

程序使用以下Python标准库，无需额外安装：
- `os` - 文件和目录操作
- `re` - 正则表达式
- `json` - JSON数据处理
- `time` - 时间处理
- `requests` - HTTP请求
- `urllib.parse` - URL解析
- `sys` - 系统相关
- `subprocess` - 子进程管理

### 系统要求

- **Windows用户**：需要安装curl命令（通常Windows 10已预装）
- **Linux/macOS用户**：curl通常已预装

## 快速开始

### 1. 配置设置

编辑 `config.json` 文件：

```json
{
    "stock_code": "600519",
    "f_node": "0",
    "s_node": "0"
}
```

### 2. 运行程序

```bash
python main.py
```

### 3. 查看结果

程序运行完成后，PDF文件将保存在以股票简称命名的文件夹中，按公告类型分类。

## 配置说明

### config.json 参数详解

| 配置项            | 说明         | 示例值   | 默认值 |
| ----------------- | ------------ | -------- | ------ |
| stock_code        | 股票代码     | 600519   | 601225 |
| f_node            | 公告大类     | 0        | 1      |
| s_node            | 公告小类     | 0        | 1      |
| cache_expire_days | 缓存过期天数 | 7        | 7      |

### 公告类型配置

#### 公告大类 (f_node)

| f_node值 | 含义     | 说明 |
|----------|----------|------|
| 0        | 全部     | 下载所有类型的公告 |
| 1        | 财务报告 | 包含定期报告、业绩预告等 |
| 2        | 融资公告 | 新股发行、增发、配股等 |
| 3        | 风险提示 | 各类风险提示公告 |
| 4        | 信息变更 | 公司信息变更公告 |
| 5        | 重大事项 | 重大合同、投资、股权激励等 |
| 6        | 资产重组 | 要约收购、吸收合并、回购等 |
| 7        | 持股变动 | 股东持股变动公告 |

#### 公告小类 (s_node)

公告小类与公告大类配对使用：

| f_node值 | s_node值 | 含义       | 说明 |
|----------|----------|------------|------|
| 0        | 0        | 全部       | 下载所有公告 |
| 1        | 1        | 定期报告   | 年报、季报、半年报 |
| 1        | 5        | 业绩预告   | 业绩预告公告 |
| 1        | 6        | 业绩快报   | 业绩快报公告 |
| 1        | 13       | 利润分配   | 分红派息公告 |
| 2        | 2        | 新股发行   | 首次公开发行 |
| 2        | 3        | 增发       | 定向增发、公开增发 |
| 2        | 4        | 配股       | 配股公告 |
| 5        | 7        | 重大合同   | 重大合同签署 |
| 5        | 8        | 投资相关   | 对外投资、收购等 |
| 5        | 9        | 股权激励   | 股权激励计划 |
| 6        | 10       | 要约收购   | 要约收购公告 |
| 6        | 11       | 吸收合并   | 吸收合并公告 |
| 6        | 12       | 回购       | 股份回购公告 |

## 使用示例

### 下载贵州茅台全部公告（7天缓存）

```json
{
    "stock_code": "600519",
    "f_node": "0",
    "s_node": "0",
    "cache_expire_days": 7
}
```

### 下载特定类型公告（3天缓存）

```json
{
    "stock_code": "000001",
    "f_node": "1",
    "s_node": "1",
    "cache_expire_days": 3
}
```

### 禁用缓存（设置为0天）

```json
{
    "stock_code": "600519",
    "f_node": "0",
    "s_node": "0",
    "cache_expire_days": 0
}
```

## 程序特性

### 智能文件命名

程序会自动生成规范的文件名：
- 格式：`{股票代码}{股票简称}{公告标题}{日期}.pdf`
- 自动去除特殊字符，只保留中文、数字、字母
- 避免文件名过长或包含非法字符

### PDF下载优化

- **文件存在检查**：下载前自动检查PDF文件是否已存在
- **完整性验证**：检查文件大小是否与期望大小相符，确保文件完整
- **跳过重复下载**：已存在且完整的文件自动跳过，避免重复下载
- **自动重新下载**：不完整的文件会自动重新下载
- **文件大小显示**：显示已存在文件的大小信息和完整性状态
- **下载状态提示**：清晰显示下载进度和状态

### 智能缓存机制

- **自动缓存**：所有API请求数据自动保存到本地缓存
- **避免重复请求**：相同URL的请求优先使用缓存数据
- **智能URL处理**：自动去除URL中的时间戳参数（cb、_），确保相同请求能命中缓存
- **人类可识别**：使用股票代码、请求类型、页码等信息生成可识别的文件名
- **按股票分类**：缓存文件按股票代码分类保存到不同文件夹
- **元数据存储**：缓存文件包含请求时间、原始URL等元数据信息
- **缓存过期机制**：支持配置缓存过期天数，过期后自动重新请求
- **自动清理**：程序启动时自动清理过期的缓存文件
- **JSON格式存储**：缓存数据以JSON格式保存，便于查看和调试
- **缓存目录**：所有缓存文件存储在`cache/`目录中，按股票代码分类

**文件命名规则**：
- **公告列表**：`{股票代码}/announcement_list_page_{页码}.json`
- **公告详情**：`{股票代码}/announcement_detail_{art_code}.json`
- **示例**：`600519/announcement_list_page_1.json`、`600519/announcement_detail_123456.json`

**缓存数据格式**：
```json
{
  "metadata": {
    "cache_time": "2024-01-15T10:30:00",
    "original_url": "原始请求URL",
    "cache_file": "缓存文件路径",
    "cache_expire_days": 7
  },
  "data": {
    // 实际的API响应数据
  }
}
```

**技术细节**：
- 程序会自动解析URL参数，移除`cb`（回调函数名）和`_`（时间戳）参数
- 例如：`https://api.example.com/data?cb=jQuery123_456&param=value&_=1234567890` 
  会被处理为：`https://api.example.com/data?param=value`
- 这样确保相同API请求（忽略时间戳）能够正确命中缓存
- 缓存过期检查基于文件创建时间，超过配置天数后自动失效
- 程序启动时会自动清理所有过期的缓存文件，释放磁盘空间
- 缓存文件包含完整的元数据，便于后续数据处理和清洗

### 下载重试机制

- 最多重试3次
- 自动验证文件大小完整性
- 文件大小不符时自动重新下载
- 每次重试间隔1秒

### 文件完整性检查

- **独立函数**：`check_pdf_integrity()` 函数专门用于检查PDF文件完整性
- **大小比较**：比较实际文件大小与期望大小，允许10KB的误差
- **智能判断**：只有当实际大小明显小于期望大小时才认为不完整
- **复用性强**：可在文件存在检查和下载后验证中复用
- **详细反馈**：提供具体的文件大小信息和完整性状态

### 反爬虫措施

- 随机User-Agent
- 请求间隔延迟（1-2秒）
- 分页处理，避免一次性请求过多数据

### 缓存管理功能

- **缓存列表**：`list_cache_files()` 函数可列出所有缓存文件及其元数据
- **元数据获取**：`get_cache_metadata()` 函数可获取指定缓存文件的详细信息
- **格式兼容**：支持新旧缓存格式，自动识别和处理
- **数据提取**：可直接从缓存文件中提取原始API数据用于后续处理

**缓存文件示例**：
```
cache/
├── 600519/                           # 贵州茅台缓存目录
│   ├── announcement_list_page_1.json
│   ├── announcement_list_page_2.json
│   └── announcement_detail_123456.json
└── other_unknown.json                           # 其他类型请求缓存
```

## 错误处理

程序包含完善的错误处理机制：

- **网络错误**：自动重试，最多3次
- **文件下载失败**：验证文件大小，不完整时重新下载
- **解析错误**：跳过错误数据，继续处理其他公告
- **目录创建失败**：自动创建必要的文件夹结构

## 注意事项

1. **网络环境**：确保网络连接稳定，能够访问东方财富网站
2. **存储空间**：确保有足够的磁盘空间存储PDF文件和缓存数据
3. **下载速度**：程序设置了合理的延迟，避免对目标网站造成压力
4. **文件覆盖**：同名文件会被覆盖，请注意备份重要文件
5. **使用频率**：建议不要过于频繁地运行程序，避免被网站限制
6. **缓存管理**：缓存文件会占用磁盘空间，可定期清理`cache/`目录
7. **缓存更新**：如需获取最新数据，可删除对应的缓存文件或整个`cache/`目录

## 技术支持

如遇到问题，请检查：

1. 网络连接是否正常
2. 配置文件格式是否正确
3. Python环境是否满足要求
4. curl命令是否可用（Windows用户）

## 更新日志

- **v1.0**：基础功能实现，支持公告下载和分类存储
- 支持多种公告类型配置
- 内置反爬虫和重试机制
- 智能文件命名和完整性验证
